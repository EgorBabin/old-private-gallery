# Приватная галерея

## Возможности
- Безопасный доступ к изображениям и видео
- Временные и одноразовые ссылки на изображения
- Логирование действий в Telegram 
- Воспроизведение видео через Range Requests

## Технологии
- nginx с PHP‑FPM
- Composer
- PHP 8.3 (+ расширение curl)  
- AWS S3 (aws-sdk-php)
- OAuth2: Google API Client, Yandex OAuth2
- Swiper.js для карусели

## Установка
**Замените домен example.com во Всех файлах, на свой!**
*Некоторые функции более подробны описаны после раздела Установка*

### 1. Подготовка сервера
- Установите:
    - **Nginx** с поддержкой PHP‑FPM
    - **PHP 8.3** с модулем `curl`
    - **Composer**

### 2. Клонирование проекта
```bash
git clone https://github.com/EgorBabin/old-private-gallery.git
cd old-private-gallery
composer install
```

### 3. Настройка 
#### Google
    Создайте проект в [console.cloud.google.com](https://console.cloud.google.com/)
    1. Найдите Google Auth Platform - [console.cloud.google.com/auth/](https://console.cloud.google.com/auth/)
    2. Заполните данные.
    3. Домашняя страница приложения - `https://example.com`
    4. Авторизованный домен - `example.com`
    5. Во вкладке Clients нажмите на созданный проект
    6. Авторизованные URI перенаправления - `https://example.com/auth/google.php`
    7. Нажмите `Добавить секрет`
    8. Скачайте его, скопируйте содержимое и вставьте в `client_secret_.apps.googleusercontent.com.json`

#### Yandex
    Создайте приложение в [oauth.yandex.ru](https://oauth.yandex.ru/)
    Выберете
    1. Платформы приложений - `Веб-сервисы` - галочка
    2. Redirect URL - `https://example.com/auth/yandex.php`
    3. Suggest Hostname - `https://example.com`

    Права доступа к данным пользователей
    Галочка напротив 
    4. Доступ к адресу электронный почты
    5. Доступ к номеру телефона

    Откройте файл в проекте www/config.php
    Скопируйте в вставьте из выданного яндекса секрета
    `clientId` и `clientSecret`

### 4. Настройка Telegram логирования

- Создайте бота, добавьте его в группу.
- В `www/example.com/S/log.php` укажите:
    ```php
    $botToken = "ВАШ_ТОКЕН";
    $chatID = "ID_ГРУППЫ";
    ```

### 5. Настройка конфигураций
- Заполните файлы:
    - `www/example.com/config.php` — основные ключи для приватного AWS S3.
    - `www/example.com/defines.php` — название сайта, домен, ssl.
    - `www/example.com/users.php` — массив разрешённых пользователей (email / телефон).

### 6. Конфигурация Nginx
Добавьте в конфигурацию nginx редирект, для красивых URL:

```nginx
rewrite ^/(\d+)/(\w+)$ /photos.php?y=$1&c=$2 last;
```

### 7. Подготовка фронтенда
- Проверьте, что `www/example.com/cards.json` содержит ваши категории (year + category и т.д.).
- Загрузите картинки для обложек в `www/example.com/img/` (например `winter.jpg`, `1winter.jpg`, `2winter.jpg` и т.д.).
- SVG иконки для карточек разместите в `www/example.com/ico/`.

### 8. Настройка S3
- Разместите медиа в S3 по структуре:
    ```
    p/{year}/{category}/         — сжатые изображения (.jpg)
    p/{year}/{category}/v        — сжатые изображения для видео, с префиксом "v" (.jpg)
    p/{year}/{category}/org/     — оригиналы c (.jpg)
    p/{year}/{category}/video/   — видео (.mp4)
    ```

### 9. Проверка
- Перейдите в браузере на ваш домен и убедитесь, что:
    - Не возможно зайти на сайт без авторизации.
    - Работает авторизация через Google/Yandex.
    - Отображаются карточки с обложками.
    - Открываются фотографии и видео с временными ссылками.

## Безопасность
Все API и страницы имеют обязательное подключения скрипта S/checkauth.php,
В котором идет проверка:
- На бота - редирект на meta.php
- На наличие сессии подтверждающий авторизацию (+ запоминает адрес на который хотел войти user, чтобы при авторизации предложить вернуться (S/redirectURL.php))
- Проверка наличия всех параметров сессии (data, serves, agent)
- Проверка на совпадение хэшированного userAgent выданный браузером

Присутствует логирование через телеграм бота в группу
Вам нужно создать бота, создать группу, добавить туда бота
Взять токен бота, id группы и подставить их в S/log.php
В $botToken и $chatID
Пишется:
Действие, Email/телефон, Тип устройства (пк/телефон), Время, Ip адрес, Адрес url от который совершено действие, Сервис (google/yandex - через что авторизовался пользователь)
Есть анти-спам от своего же сервера (при использовании панели, она сама заходила на сайт n в час)

S3 Картинки выдаются только на 60 секунд
Предполагается, что за это время, сильно сжатые изображения (маловесящие) полностью загрузятся на страницу (photos.php).
Оригинальное же изображение (по клику), загружается сразу и всё (image.php).

В `config.php`
В виде массива заполняется по типу Ключ - значение 
Для AWS (s3)
Для yandex OAuth2-клиент

В `client_secret_.apps.googleusercontent.com.json`
Предоставлена примерная структура выданная google для OAuth2
Которую вы можете заменять на свою, со значениями

В `defines.php`
Подставляем: Название сайта, домен, слоган (OpenGraph), описание (OpenGraph), ssl - есть или нету сертификата

## Авторизация:
Имеется для входа сервисы OAuth2 от Google, Yandex

Для **google**
Используется предоставленная им библиотека 
Подключается по autoload.php

При входе пользователя проверяем на код авторизации,
Берем email для проверки на присутствие в users.php.
Если имеется email, то создаем для него сессию
Если же нет, редиректем пользователя на non.php

Для **yandex**
Библиотека не используется, но имеется генерация CSRF-токена
Тут уже мы берем email и номер телефона
Чтобы можно было войти также по номеру через yandex

После входа мы попадаем на index

## Отображение
В nginx
Обязательно сделать редирект на
```rewrite ^/(\d+)/(\w+)$ /photos.php?y=$1&c=$2 last;```
Он смотрит запрос типа
`example.com/2019/travel/`
И преобразует для системы - незаметно для пользователя
`example.com/photos.php?y=2019&c=travel`

- Без этого не будет работать страница с витриной фотографий - photos.php
Разумеется, вы можете не делать этого
И сделать путь прям такой:
`example.com/photos.php?y=[year]&c=[category]`

Обязательно должны быть данные в **cards.json**
Где для пути используется
*year* и *category*
По этому на английском.

*image* - это картинка будет отображаться на обложке
Предполагается, что в вас их 3 штуки и название первой будет указано в json
То есть должно получиться для каждой карточки примерно так:
winter.jpg
*1*winter.jpg
*2*winter.jpg
Они располагаются в папке *img/*

*title* - Название уже на любом языке
Оно будет отображаться на страницах и на карточках индекса.

*icon* - svg картинки, стоящие после title для украшения
Находятся в папке *ico/*

*amt* - количество изображений (к этому не относятся привью видео)
*video* - количество видео

## API
При загрузке на страницу изображений
Выдается каждому значение в alt - video/image
id содержит в себе свой порядковый номер,
Чтобы в url можно было указать якорь и переходить сразу к нужному

При клике смотрится 
Изображение:
Открывается окно, и составляется запрос к api по типу
`example.com/image.php?path=p/${year}/${category}/org/${imageAlt}.jpg`
Выводится оригинальная картинка - в высоком разрешении.
Если же она не найдена, появиться svg иконка - ico/404img.svg

Видео:
Изначально все видео - изображения с названием, содержащим в начале v
Будут помечаться иконкой треугольника.
При клике
Составляется api запрос 
`example.com/mediaS3.php?y=${year}&c=${category}&media=${videoAlt}`
Появиться "уведомление" - подсказка
О том что началась загрузка.
При клике по нему, можно как по якорю пролистать до неё
Вывод стриминговый - выдача идет по чанкам
Протокол HTTP Range Requests
Если не поддерживается - отдаем весь файл сразу

## Материалы *s3*
Все изображения имеют свой порядковый номер, с расширением .jpg
Картинки от видео также и идут вместе с обычными изображениями
Но, имеют в начале названия, помимо номера - "v"
То есть например
1.jpg - изображение
2.jpg - изображение
v3.jpg - изображение от видео (привью)
v4.jpg - изображение от видео (привью)
5.jpg - изображение
...

Размещаются в s3 по пути

p/year/category/ тут изображения *Сжатые*
p/year/category/org/ тут изображения *Оригинальные*

p/year/category/ тут обложка видео, сжатая в .jpg
p/year/category/video/ тут находится видео, формата .mp4 (я использовал av1 кодек)

## Структура проекта:
*Что, зачем - постарался описать в каждом файле*
```
└── / — Корень проекта
    ├── composer.json — PHP-зависимости
    ├── NGINX.conf — Конфиг NGINX для развёртывания
    ├── README.md — Этот файл
    └── 📁www — Исходники сайта
        ├── client_secret_.apps.googleusercontent.com.json — OAuth2-клиент Google (шаблон)
        ├── config.php — Основная конфигурация (PHP-массив)
        └── 📁example.com — Публичная часть
            └── 📁auth — Сервисы авторизации, OAuth2-клиент
                ├── google.php — Через Google
                ├── yandex.php — Через Yandex
            └── 📁ico — Svg иконки
                ├── img.svg
                ├── ....
            └── 📁img — Изображения для карточек на индексе
                ├── README.md
            └── 📁lib — Библиотеки
                └── 📁swiper
                    ├── swiper-bundle.min.css
                    ├── swiper-bundle.min.js
            └── 📁S — Скрипты js, php
                ├── animh.js — Анимация скрытия кнопки (бесполезна)
                ├── animi.js — Анимация скрытия контейнера (бесполезна)
                ├── checkauth.php — Проверка пользователя на авторизацию
                ├── display.js — Для работы API с s3, подробнее в README
                ├── log.php — Бот телеграм для логирования
                ├── progress-bar.html — Показ скролла сверху
                ├── redirectURL.php — Предложение о возврате
                ├── skelet.js — Скелет загрузки
                ├── sort.js — Сортировка фотографий
                ├── touch.js — Закрытие фотографии по свайпу
                ├── video.js — Для API видео
            ├── auth.php — Страница выбора сервисы авторизации
            ├── cards.json — Данные для отображения карточек
            ├── defines.php — Глобальные константы и пути
            ├── image.php — API получения оригинальной картинки, S3
            ├── index.php — Главная страница
            ├── mediaS3.php — API получения видео, S3
            ├── meta.php — Мета данные для Open Graph
            ├── non.php — Страница редиректа, если данные пользователя не найдены в базе
            ├── photos.php — Страница с фотографиями, S3
            ├── robots.txt — Настройка для Не индексации сайта
            ├── style.css — Стили
            └── users.php — Мини-база данных доступных пользователей (PHP-массив)
```

## История
Это приватная галерея
Разработана поскольку в некоторых странах блокируют сайты, и чтобы не переходить из раза в раз в другой сервис, я создал это.
Что-то свое..

Проект тянется как хобби с 2023 года
Переросший больше в глубокую память и воспоминания

2023 — запуск, 2024 — переход на PHP и S3, 2025 — финальная версия с OAuth2
Есть еще что добавить в нем

## Licenses
Этот проект распространяется по лицензии MIT. Подробнее см. в файле LICENSE.
Проект использует следующие внешние компоненты:

- **nginx** с PHP‑FPM — (BSD‑style) [LICENSE](https://nginx.org/LICENSE)  
- **Composer** — (MIT) [LICENSE](https://github.com/composer/composer/blob/main/LICENSE)  
- **PHP 8.3** — (PHP License) входит в дистрибутив PHP  
- **aws‑sdk‑php** — (Apache 2.0) [LICENSE](https://github.com/aws/aws-sdk-php/blob/master/LICENSE)  
- **google/apiclient** — (Apache 2.0) [LICENSE](https://github.com/googleapis/google-api-php-client/blob/master/LICENSE)  
- **Yandex OAuth2** — используется публичный API без отдельной библиотеки  
- **Swiper.js** — (MIT) [LICENSE](https://github.com/nolimits4web/swiper/blob/master/LICENSE)
- **Nunito (Google Fonts)** — (SIL Open Font License 1.1) [LICENSE](https://scripts.sil.org/OFL)


# Спасибо.
[egor.life](http://egor.life)
Сделано с ❤️ в 2023-2025

---

MIT License
Copyright (c) 2025 EgorBabin